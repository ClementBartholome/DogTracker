@page "/dog/{DogId:int}/walk"
@inject ILocationService LocationService
@inject IDogService DogService
@inject IJSRuntime JsRuntime
@using DogTracker.Interfaces
@using DogTracker.Models
@using DogTracker.ViewModels
@rendermode InteractiveServer

<div class="mx-auto">
    <MudPaper class="p-4 mb-4">
            <MudText Typo="Typo.h4" class="mb-2">Promenades</MudText>

            @if (!isTracking)
            {
                <MudButton OnClick="StartWalk" Color="Color.Primary" Variant="Variant.Filled"
                           class="w-full text-white font-bold py-3 rounded-lg mb-4">
                    Démarrer la promenade
                </MudButton>
            }
            else
            {
                <div class="space-y-4">
                    <div class="text-center">
                        <p class="text-xl">Durée: @GetFormattedDuration()</p>
                        <p class="text-lg">Distance: @(currentDistance.ToString("F2")) km</p>
                    </div>

                    <MudButton OnClick="StopWalk" Color="Color.Primary" Variant="Variant.Filled"
                               class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg">
                        Terminer la promenade
                    </MudButton>
                </div>
            }
    </MudPaper>

    <div id="map" style="height: 300px;" class="mb-4 rounded-lg w-100"></div>

    @if (isLoading)
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="110px"/>
    }
    else
    {
        @if (walkHistory?.Any() == true)
        {
            <MudPaper Class="p-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-4">Historique des Promenades</MudText>
                <MudList T="object">
                    @foreach (var walk in walkHistory.OrderByDescending(w => w.StartTime).Select(w => new WalkViewModel(w)))
                    {
                        <MudListItem>
                            <div class="d-flex">
                                <MudText
                                    Typo="Typo.subtitle1">@walk.AdjustedStartTime.ToString("dd/MM/yyyy HH\\hmm")
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" aria-label="delete"
                                               Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                               class="ml-auto"
                                               OnClick="@(() => DeleteWalk(1, walk.Id))"/>
                                <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" aria-label="more"
                                               Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                               class="ml-2"
                                               Href="@($"/walk/{walk.Id}")"/>

                            </div>
                            <MudText Typo="Typo.body2" Class="text-gray-600">
                                <span>@walk.Distance.ToString("F2") km</span>
                                <span>@((walk.AdjustedEndTime - walk.AdjustedStartTime).TotalMinutes.ToString("F0")) min</span>
                            </MudText>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        }
        else
        {
            <MudPaper Class="p-4">
                <MudText Typo="Typo.body1" Class="text-gray-600">Aucune promenade enregistrée.</MudText>
            </MudPaper>
        }
    }
</div>