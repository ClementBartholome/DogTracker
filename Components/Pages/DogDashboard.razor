@page "/"
@using DogTracker.Interfaces
@using DogTracker.Components.Layout
@rendermode InteractiveServer

<MudText Typo="Typo.h4" Class="pl-3 pt-3">Tableau de bord</MudText>
<MudGrid Class="mt-2">
    <MudItem xs="12" md="3">
        <MudCard Class="p-3">
            <MudText Typo="Typo.subtitle1">Récap des promenades aujourd'hui</MudText>
            @if (isLoading)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="110px"/>
            }
            else if (!_recentWalks.Any())
            {
                <MudText Typo="Typo.body1">Aucune promenade enregistrée aujourd'hui</MudText>
            }
            else
            {
                <div class="d-flex justify-content-around mt-2">
                    <div class="mt-2 d-flex flex-column align-items-center">
                        <MudText Typo="Typo.body1" Class="fw-bold">@(_totalDurationToday ?? "0 min")</MudText>
                        <MudText Typo="Typo.caption">Durée</MudText>
                    </div>
                    <div class="mt-2 d-flex flex-column align-items-center">
                        <MudText Typo="Typo.body1" Class="fw-bold">@_totalDistanceToday.ToString("F2") km</MudText>
                        <MudText Typo="Typo.caption">Distance</MudText>
                    </div>
                    <div class="mt-2 d-flex flex-column align-items-center">
                        <MudText Typo="Typo.body1" Class="fw-bold">@_totalWalksToday</MudText>
                        <MudText Typo="Typo.caption">@(_totalWalksToday >= 1 ? "Promenades" : "Promenade")</MudText>
                    </div>
                </div>
            }
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="3">
        <MudCard Class="p-3">
            <MudText Typo="Typo.subtitle1">Dernière promenade</MudText>
            @if (isLoading)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="110px"/>
            }
            else if (!_recentWalks.Any())
            {
                <MudText Typo="Typo.body1">Aucune promenade enregistrée</MudText>
            }
            else
            {
                var lastWalk = _recentWalks.First();
                <div class="mt-2 d-flex flex-column gap-2 pl-4">
                    <MudText Typo="Typo.body1">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Class="mr-1" />
                        @lastWalk.AdjustedStartTime.ToString("dd/MM/yyyy à HH\\hmm")
                    </MudText>
                    <MudText Typo="Typo.body1">
                        <MudIcon Icon="@Icons.Material.Filled.DirectionsWalk" Class="mr-1" />
                        @lastWalk.Distance.ToString("F2") km
                    </MudText>
                    <MudText Typo="Typo.body1">
                        <MudIcon Icon="@Icons.Material.Filled.Timer" Class="mr-1" />
                        @{
                            var lastWalkDuration = (lastWalk.AdjustedEndTime - lastWalk.AdjustedStartTime).TotalMinutes;
                            var formattedDuration = lastWalkDuration < 60 ? $"{lastWalkDuration:F0} min" : $"{lastWalkDuration / 60:F0}h{lastWalkDuration % 60:F0}";
                        }
                        @formattedDuration
                    </MudText>
                </div>
            }
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="3">
        <MudCard Class="p-3">
            <MudText Typo="Typo.subtitle1">Poids actuel</MudText>
            @if (isLoading)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="60px"/>
            }
            else if (!_weightHistory.Any())
            {
                <MudText Typo="Typo.body1" Class="pl-4">Aucun poids enregistré</MudText>
            }
            else
            {
                var currentWeight = _weightHistory.OrderByDescending(w => w.Date).First();
                <div class="mt-2 pl-4">
                    <MudText Typo="Typo.body1">
                        <MudIcon Icon="@Icons.Material.Filled.Scale" Class="mr-1" />
                        @currentWeight.Weight kg
                    </MudText>
                    <MudText Typo="Typo.body1">Dernière mesure prise le @currentWeight.Date.ToString("dd/MM/yyyy")</MudText>
                </div>
            }
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="3">
        <MudCard Class="p-3">
            <MudText Typo="Typo.subtitle1">Dépenses du mois</MudText>
            @if (isLoading)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="60px"/>
            }
            else if (!_expenses.Any())
            {
                <MudText Typo="Typo.body1" Class="pl-4">Aucune dépense enregistrée</MudText>
            }
            else
            {
                var monthlyTotal = _expenses
                    .Where(e => e.Date.Month == DateTime.Now.Month)
                    .Sum(e => e.Amount);
                <div class="mt-2 pl-4">
                    <MudText Typo="Typo.body1">
                        <MudIcon Icon="@Icons.Material.Filled.Wallet" Class="mr-1" />
                        @monthlyTotal.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"))
                    </MudText>
                    <MudText Typo="Typo.body1">Dernière dépense enregistrée le @(_expenses.OrderByDescending(e => e.Date).FirstOrDefault()?.Date.ToString("dd/MM/yyyy à HH\\hmm") ?? "N/A")</MudText>
                </div>
            }
        </MudCard>
    </MudItem>
</MudGrid>

<RadialMenu/>